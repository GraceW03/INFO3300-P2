<html>

<head>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script src="https://d3js.org/topojson.v3.min.js"></script>
  <link rel="stylesheet" href="styles/style.css">
</head>


<style>
  .state {
    fill: lightgrey;
  }

  .outline {
    fill: none;
    stroke: black;
    stroke-width: 1px;
  }

  .graticule {
    fill: none;
    stroke: grey;
    stroke-width: 1px;
  }

  .tooltip {
    pointer-events: none;
  }
</style>

<body>

  <svg id="lineplot" height="500" width="800" style="margin-top:50px">
  </svg>

  <script>

    // Line graph

    const svg = d3.select("svg#lineplot");
    const width = svg.attr("width");
    const height = svg.attr("height");
    const margin = { top: 10, right: 10, bottom: 50, left: 50 };
    const chartWidth = width - margin.left - margin.right;
    const chartHeight = height - margin.top - margin.bottom;

    let annotations = svg.append("g").attr("id", "annotations");
    let chartArea = svg.append("g").attr("id", "points")
      .attr("transform", `translate(${margin.left},${margin.top})`);

    // Import some CSV data
    d3.csv("./data/us_state_vaccinations.csv", d3.autoType)
      .then((data) => {

        const timeFormatter = d3.timeFormat('%Y-%m');

        data.forEach(d => {
          d['month'] = timeFormatter(d['date']);
        });

        console.log(data);

        let stateDict = {}; // stateID ===> stateData
        data.forEach(d => {
          if (stateDict[d.location]) {
            stateDict[d.location].push({ month: d.month, people_fully_vaccinated: d.people_fully_vaccinated });
          } else {
            stateDict[d.location] = [{ month: d.month, people_fully_vaccinated: d.people_fully_vaccinated }];
          }
        });

        const flatData = Object.keys(stateDict).map(state => ({
          state,
          values: stateDict[state].filter(d => d.people_fully_vaccinated != null)
        }));

        const allMonths = Array.from(new Set(data.map(d => d.month))).sort();
        const yExtent = d3.extent(data, d => d.people_fully_vaccinated);
        const xScale = d3.scalePoint().domain(allMonths).range([0, chartWidth]);
        const yScale = d3.scaleLinear().domain(yExtent).range([chartHeight, 0]);


        // // Add axes
        annotations.append("g")
          .attr("class", "y axis")
          .attr("transform", `translate(${margin.left - 10}, ${margin.top})`)
          .call(d3.axisLeft(yScale));

        annotations.append("g")
          .attr("class", "x axis")
          .attr("transform", `translate(${margin.left}, ${chartHeight + margin.top + 10})`)
          .call(d3.axisBottom(xScale).tickValues(allMonths).tickFormat(d3.timeFormat("%Y-%m")));

        // // Create line generator
        const lineGen = d3.line()
          .x(d => xScale(d.month))
          .y(d => yScale(d.distributed_per_hundred))
          .defined(d => !isNaN(d.distributed_per_hundred)) // Skip NaN values
          .curve(d3.curveMonotoneX);

        // // Draw lines for each state
        flatData.forEach(stateData => {
          chartArea.append("path")
            .datum(stateData.values)
            .attr("class", "line")
            .attr("d", lineGen)
            .attr("stroke", d3.schemeCategory10[Object.keys(stateDict).indexOf(stateData.state) % 10])
            .attr("stroke-width", 2)
            .attr("fill", "none")
            .append("title")
            .text(stateData.state);
        });

      });




  </script>

</body>

</html>