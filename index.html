<html>

<head>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script src="https://d3js.org/topojson.v3.min.js"></script>
  <link rel="stylesheet" href="styles/style.css">
</head>

<!-- put any CSS in styles/style.css -->

<body>



  <!-- First SVG section with interactive map + bar charts -->
  <svg id="choropleth" height="500" width="600"></svg>
  <svg id="bar1" height="250" width="400"></svg>
  <svg id="bar2" height="250" width="400"></svg>

  <!-- Scrolling bar for timeline -->
  <input type="range" id="slider-value" name="slider-value" value="0" min="0" max="100" step="1"
    style="width: 1000px; margin-top: 10px;" />
  <label for="slider-value" id="date">Date: </label>

  <script>
    const requestData = async function () {
      /*************************** Work with slider **************************/


      const svg = d3.select("#choropleth");
      const width = svg.attr("width");
      const height = svg.attr("height");
      const margin = { top: 20, right: 20, bottom: 20, left: 20 };
      const mapWidth = width - margin.left - margin.right;
      const mapHeight = height - margin.top - margin.bottom;

      /*************************** Create the map **************************/
      // referenced October 9 lecture
      const us = await d3.json("./data/us-smaller.json"); // what's up with the period??? ask TA
      var states = topojson.feature(us, us.objects.states);
      var statesMesh = topojson.mesh(us, us.objects.states);
      var projection = d3.geoAlbersUsa().fitSize([mapWidth, mapHeight], states);
      var path = d3.geoPath().projection(projection);
      console.log(states);
      console.log(statesMesh);

      const map = svg.append("g")
        .attr("transform", "translate(" + margin.left + "," + margin.top + ")");


      // draw states and outlines (see CSS at the top)
      let statePaths = map.selectAll("path.state").data(states.features)
        .join("path")
        .attr("class", "state")
        .attr("note", d => d.id)
        .attr("d", path)
        .on('mouseover', mouseEntersState)
        .on('mouseout', mouseLeavesState);

      map.append("path").datum(statesMesh)
        .attr("class", "outline")
        .attr("d", path);

      /********** END NOTES ***************/


      /********** Upload data for map ***************/
      const vaccineData = await d3.csv("./data/us_state_vaccinations.csv", d3.autoType);

      // aggregate data by state, get total and add it
      var stateDict = {}   // stateID ===> stateData
      vaccineData.forEach(d => {
        if (stateDict[d.location]) {
          stateDict[d.location] += d.total_vaccinations;
        } else {
          stateDict[d.location] = d.total_vaccinations;
        };
      });

      const minMax = d3.extent(Object.values(stateDict));
      console.log(minMax);

      const colorScale = d3.scaleQuantile()
        .domain(Object.values(stateDict))
        .range(["#ddd", "#d1e8ed", "#adc2da", "#8879b3", "#762b80"]);

      console.log(stateDict);


      const stateCodes = await d3.csv("./data/state_codes.csv", d3.autoType);
      var codeDict = {}
      stateCodes.forEach(d => {
        codeDict[d.state_code] = d.state_name;
      });


      map.selectAll(".state")
        .style("fill", d => {
          return colorScale(stateDict[codeDict[d.id]]);
        });

      //hover and add box for a more detailed view into the data

      let tooltipWidth = 120;
      let tooltipHeight = 40;

      let momesh = map.append("path")
        .attr("class", "mouseover outline")
        .style("stroke", "black")
        .style("stroke-width", 3)
        .attr("d", "");

      let tooltip = map.append("g")
        .attr("class", "tooltip")
        .attr("visibility", "hidden");
      tooltip.append("rect")
        .attr("fill", "black")
        .attr("opacity", 0.9)
        .attr("x", -tooltipWidth / 2.0)
        .attr("y", 0)
        .attr("width", tooltipWidth)
        .attr("height", tooltipHeight)
      let txt = tooltip.append("text")
        .attr("fill", "white")
        .attr("text-anchor", "middle")
        .attr("alignment-baseline", "hanging")
        .attr("x", 0)
        .attr("y", 2)
        .attr("font-size", "10px");
      let txt2 = tooltip.append("text")
        .attr("fill", "white")
        .attr("text-anchor", "middle")
        .attr("alignment-baseline", "hanging")
        .attr("x", 0)
        .attr("y", 22)
        .attr("font-size", "10px");

      function mouseEntersState() {
        tooltip.style("visibility", "visible")

        let state = d3.select(this);
        let stateID = state.datum().id;
        let stateName = codeDict[stateID];
        let totalVaccinations = stateDict[stateName];

        txt.text(stateName);
        txt2.text(totalVaccinations ? `Total: ${totalVaccinations}` : "Data unavailable");


        let bounds = path.bounds(state.datum());
        let xPos = (bounds[0][0] + bounds[1][0]) / 2.0;
        let yPos = bounds[1][1] - 15;

        tooltip.attr("transform", `translate(${xPos},${yPos})`);

        var mo = topojson.mesh(us, us.objects.states, function (a, b) { return a.id === stateID || b.id === stateID; });
        momesh.datum(mo).attr("d", path)

      }

      function mouseLeavesState() {
        tooltip.style("visibility", "hidden");

        let state = d3.select(this);
        momesh.attr("d", "");
      }

      /****************** Panning and Zooming on Map *******************/
      var zoom = d3.zoom()
        .scaleExtent([1, 20])
        .translateExtent([[-50, -50], [mapWidth + 50, mapHeight + 50]])
        .on("zoom", mapZoomed);

      svg.call(zoom);

      svg.call(zoom.transform, d3.zoomIdentity);

      // referenced zooming and panning lecture
      function mapZoomed({ transform }) {
        map.attr("transform", transform.toString());

        map.select(".state-outline")
          .style("stroke-width", 2 / transform.k);
      }


      // Click on a state/county to zoom in on it, and again to zoom out
      map.selectAll(".state").on("click", clicked);

      var stateClicked = false;

      function clicked(event, d) { // zoom out
        console.log(d)
        if (stateClicked) {
          let translate = [margin.left, margin.right];

          let newTransform = d3.zoomIdentity
            .translate(translate[0], translate[1])
            .scale(1);
          svg.transition().duration(1000).call(zoom.transform, newTransform);

          stateClicked = false;
        }

        else { // zoom out
          // geoPath generators have a few extra functions. .bounds returns a pixel rectangle bounding the shape you give it
          let bounds = path.bounds(d.geometry);
          let dx = bounds[1][0] - bounds[0][0];
          let dy = bounds[1][1] - bounds[0][1];
          let x = (bounds[0][0] + bounds[1][0]) / 2;
          let y = (bounds[0][1] + bounds[1][1]) / 2;

          let scale = Math.max(1, Math.min(10, 0.9 / Math.max(dx / mapWidth,
            dy / mapHeight)));

          let translate = [mapWidth / 2 - x * scale, mapHeight / 2 - y * scale];

          let newTransform = d3.zoomIdentity
            .translate(translate[0], translate[1])
            .scale(scale);
          svg.transition().duration(1000).call(zoom.transform, newTransform);

          stateClicked = true;
        }
      }
    }

    requestData();

  </script>

  <!-- Line graph -->

</body>

</html>